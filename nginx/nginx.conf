user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  
  # Configurações de segurança
  server_tokens off;
  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";
  add_header Referrer-Policy "strict-origin-when-cross-origin";
  
  # Configurações de performance
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;
  types_hash_max_size 2048;
  
  # Gzip compression
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

  # Upstreams (nomes dos serviços Docker Compose)
  upstream api {
    server remediar-gateway:8080;  # Roteia para a API Gateway (na porta 8080)
  }

  upstream frontend {
    server front-remediar:3000;  # Roteia para o frontend (na porta 3000)
  }

  # Servidor HTTP (redireciona para HTTPS quando configurado)
  server {
    listen       80 default_server;
    listen       [::]:80 default_server;
    server_name  _;  # qualquer nome de host, ou seu domínio

    # Redirecionar para HTTPS se certificado estiver disponível
    # Descomente as linhas abaixo quando configurar SSL
    # return 301 https://$server_name$request_uri;

    # 1) Proxy para a API Gateway
    location /api/ {
      proxy_pass         http://remediar-gateway:8080;  # Encaminha para o API Gateway
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
      
      # Timeouts para API
      proxy_connect_timeout 60s;
      proxy_send_timeout 60s;
      proxy_read_timeout 60s;
    }

    # 2) Tudo o mais vai para o frontend
    location / {
      proxy_pass         http://frontend/;  # Encaminha para o frontend
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
      
      # Timeouts para frontend
      proxy_connect_timeout 60s;
      proxy_send_timeout 60s;
      proxy_read_timeout 60s;
    }

    # 3) Health check endpoint
    location /health {
      access_log off;
      return 200 "healthy\n";
      add_header Content-Type text/plain;
    }
  }

  # Servidor HTTPS (descomente quando configurar SSL)
  # server {
  #   listen       443 ssl http2;
  #   listen       [::]:443 ssl http2;
  #   server_name  remediar.seu-dominio.com;
  #
  #   # SSL Configuration
  #   ssl_certificate /etc/letsencrypt/live/remediar.seu-dominio.com/fullchain.pem;
  #   ssl_certificate_key /etc/letsencrypt/live/remediar.seu-dominio.com/privkey.pem;
  #   ssl_protocols TLSv1.2 TLSv1.3;
  #   ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
  #   ssl_prefer_server_ciphers off;
  #   ssl_session_cache shared:SSL:10m;
  #   ssl_session_timeout 10m;
  #
  #   # API Gateway
  #   location /api/ {
  #     proxy_pass         http://api/;
  #     proxy_http_version 1.1;
  #     proxy_set_header   Host              $host;
  #     proxy_set_header   X-Real-IP         $remote_addr;
  #     proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
  #     proxy_set_header   X-Forwarded-Proto $scheme;
  #   }
  #
  #   # Frontend
  #   location / {
  #     proxy_pass         http://frontend/;
  #     proxy_http_version 1.1;
  #     proxy_set_header   Host              $host;
  #     proxy_set_header   X-Real-IP         $remote_addr;
  #     proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
  #     proxy_set_header   X-Forwarded-Proto $scheme;
  #   }
  # }
}
